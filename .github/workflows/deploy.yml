name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: 'Azure resource group'
        required: true
        type: string
      container_name:
        description: 'Container name'
        required: true
        type: string
      registry_name:
        description: 'Azure Container Registry name'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push image
        run: |
          az acr build --registry ${{ github.event.inputs.registry_name }} \
            --image ocr-inference:${{ github.sha }} \
            --file serving/Dockerfile .

      - name: Deploy to Azure Container Instances
        run: |
          bash deployment/azure/deploy_container.sh \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --container-name ${{ github.event.inputs.container_name }} \
            --registry-name ${{ github.event.inputs.registry_name }} \
            --image-name ocr-inference:${{ github.sha }}

